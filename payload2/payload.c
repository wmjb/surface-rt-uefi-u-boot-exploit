#include <stdint.h>
#include "system_regs.h"
#include "tegra30_uart.h"
#include "printf.h"
#include "mmu_dump.h"
#include "stddef.h"

#define _MEM(addr) *(volatile uint32_t *)(addr)
#define mem_read(addr) _MEM(addr)
#define mem_write(addr, value) _MEM(addr) = value
#define mem_clear(base, value) _R_MEMEG(addr) &= ~value
#define mem_set(base, value) _RE_MEMG(addr) |= value

void memcpy_usr(void* dest, const void* src, size_t n);

void main()
{
	// CP15SDISABLE & CFGSDISABLE
	*((uint32_t*)0x6000C208) |= (0 << 4) | (0 << 5);

//	MC_SMMU_CONFIG_0 = h10
//	MC 7000:f000
	*((uint32_t*)0x7000f010) = 0;

	disable_mmu();

	printf("secondary about to die\r\n");

	memcpy_usr((void*)(0x80112174), (const void*)0x83000000, (size_t)25000); // TODO pass size from payload launcher

	clear_ns();
	
	*((uint32_t*)0x88002000) = 2; // let payload launcher know we're done

	do{}while(1);
}

void memcpy_usr(void* dest, const void* src, size_t n) {
	//cast src and dest to char*
	char *src_char = (char *)src;
	char *dest_char = (char *)dest;
	for (int i=0; i<n; i++) {
		dest_char[i] = src_char[i]; //copy contents byte by byte
	}
}
