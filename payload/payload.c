// based on ipatch_rcm_sample.c provided by ktemkin (https://gist.github.com/ktemkin/825d5f4316f63a7c11ea851a2022415a)
// unmodified copy of original source can also be found at https://github.com/tofurky/tegra30_debrick/payload/ipatch_rcm_sample.c
// ipatch_word(), unipatch_word(), dump_word(), and dump_byte() are more or less unmodified.
// clock/uart initialization and offsets have been consolidated and modified for tegra30

// begin original header
/**
 * Proof of Concept Payload
 * prints out SBK and then enables non-secure RCM 
 *
 * (some code based on coreboot)
 * ~ktemkin
 */
// end original header

#include <stdint.h>
#include "system_regs.h"
#include "tegra30_uart.h"
#include "printf.h"
#include "mmu_dump.h"

void dump_important_stuff();

void main()
{
	volatile uint32_t reg;


	printf("Payload on Core 0 Saying Hello\r\n");
	reg = get_SB_PFCFG_0();
	printf("CP15SDISABLE: %08x\r\n", reg);
	
	// CP15SDISABLE & CFGSDISABLE
	*((uint32_t*)0x6000C208) |= (0 << 4) | (0 << 5);

	reg = get_SB_PFCFG_0();
	printf("CP15SDISABLE: %08x\r\n", reg);
	
//	MC_SMMU_CONFIG_0 = h10
//	MC 7000:f000
	*((uint32_t*)0x7000f010) = 0;
	
	// Dump the flowcontroller
	// Might contain some hints about SMP problem
	uint32_t *flow_controller = (uint32_t*) 0x60007000U;
	
	for (int i = 0; i < 12; i++) {
		printf("fc%d:0x%08x\r\n", i, *(flow_controller+i));
	}

	
	disable_mmu();
	
	uint32_t *ID_base = (uint32_t*)0x50041080;
	
	for (int i = 0; i < 6; i++) {

		ID_base[i] = 0;

	}
	
	reg = get_ns();
	printf("NS: %x; %s\r\n", reg, reg == 0 ? "Secure" : "Non-Secure");
	

	printf("Finished executing payload. bye :)\r\n");
	

	
	void (*uboot)(void) = (void (*)())0x84000000U;
	uboot();

	printf("Why are we here????\r\n");
	
	while(1);
}

void dump_important_stuff() {
	volatile uint32_t reg;

	reg = get_ns();
	printf("NS: %x; %s\r\n", reg, reg == 0 ? "Secure" : "Non-Secure");

	reg = get_dacr();
	printf("DACR: %x\r\n", reg);

	//set_dacr(0xFFFFFFFF);

	//reg = get_dacr();
	//printf("DACR: %x\r\n", reg);

	printf("---------------- START DUMP MMU-------------------\r\n");
	_start();
	printf("---------------- END DUMP MMU-------------------\r\n");
}
