// based on ipatch_rcm_sample.c provided by ktemkin (https://gist.github.com/ktemkin/825d5f4316f63a7c11ea851a2022415a)
// unmodified copy of original source can also be found at https://github.com/tofurky/tegra30_debrick/payload/ipatch_rcm_sample.c
// ipatch_word(), unipatch_word(), dump_word(), and dump_byte() are more or less unmodified.
// clock/uart initialization and offsets have been consolidated and modified for tegra30

// begin original header
/**
 * Proof of Concept Payload
 * prints out SBK and then enables non-secure RCM 
 *
 * (some code based on coreboot)
 * ~ktemkin
 */
// end original header

#include <stdint.h>
#include "../common/system_regs.h"
//#include "../common/tegra30_uart.h"
//#include "../common/printf.h"
//#include "../common/mmu_dump.h"


#define _MEM(addr) *(volatile uint32_t *)(addr)
#define mem_read(addr) _MEM(addr)
#define mem_write(addr, value) _MEM(addr) = value
#define mem_clear(base, value) _MEM(addr) &= ~value
#define mem_set(base, value) _MEM(addr) |= value

// adopted from kernel code. thanks Leander :)
//struct parking_protocol_mailbox {
//	uint32_t cpu_id;
//	uint32_t reserved;
//	uint64_t entry_point; // keep at 64Bit to keep cpu_mailbox_entry aligned
//};

//struct cpu_mailbox_entry {
//	struct parking_protocol_mailbox *mailbox;
//	uint32_t mailbox_addr;
//	uint8_t version;
//	uint8_t gic_cpu_id;
//};


//void start_secondary_core(int cpu);

//void dump_important_stuff();

//extern void lock_mutex(void* mutex);
//extern void unlock_mutex(void* mutex);


// Context switch from Non-Secure to Secure.
// Need to synchronize everything
// This is inserted before main() in the binary
asm (	"isb\n"
	"dsb\n");

void main()
{
//uart_print("hi ------------\r\n");

	// Switch to Secure World
	clear_ns();

	disable_mmu();
//printf("hi --------------------------\r\n");
	// GIC: change all interrupts to secure.
	uint32_t *ID_base = (uint32_t*)0x50041080;
		ID_base[7] = 0;
                ID_base[6] = 0;
		ID_base[5] = 0;
		ID_base[4] = 0;
                ID_base[3] = 0;
                ID_base[2] = 0;
                ID_base[1] = 0;
                ID_base[0] = 0;

		// Disable the SMMU
		*((uint32_t*)0x7000f010) = 0;
//uart_print("hi---------------\r\n");
		// JUMP TO UBOOT
		void (*uboot)(void) = (void (*)())0x84000000U;

		uboot();

//	printf("Why are we here??? Something went wrong :(\r\n");
	while(1);
}

